{% comment %}
  Copyright 2023 Richard Dominick
{% endcomment %}
{%- assign types = "plantuml, puml" | split: ", " -%}
{%- assign nodes = include.html
  | strip
  | split: '<pre><code class="language-'
-%}
<script src="https://cdnjs.cloudflare.com/ajax/libs/pako/1.0.11/pako.min.js" integrity="sha512-euWc/Qv8Kp0CbTX1M+Q3BvUyoOaq9Au50TT7vz3MFf5ver39ybq6zV+RngDY8eN8AIQFigxjwYv6jhoP546vfQ==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
<script>
  // Copied from
  // https://github.com/markushedvall/plantuml-encoder/blob/master/lib/encode64.js
  function encodeToPlantumlEncoded(text) {
    function encode6bit(b) {
      if (b < 10) { return String.fromCharCode(48 + b) }
      b -= 10
      if (b < 26) { return String.fromCharCode(65 + b) }
      b -= 26
      if (b < 26) { return String.fromCharCode(97 + b) }
      b -= 26
      if (b === 0) { return '-' }
      if (b === 1) { return '_' }
      return '?'
    }
    
    function append3bytes(b1, b2, b3) {
      var c1 = b1 >> 2
      var c2 = ((b1 & 0x3) << 4) | (b2 >> 4)
      var c3 = ((b2 & 0xF) << 2) | (b3 >> 6)
      var c4 = b3 & 0x3F
      var r = ''
      r += encode6bit(c1 & 0x3F)
      r += encode6bit(c2 & 0x3F)
      r += encode6bit(c3 & 0x3F)
      r += encode6bit(c4 & 0x3F)
      return r
    }

    function encode(data) {
      var r = ''
      for (var i = 0; i < data.length; i += 3) {
        if (i + 2 === data.length) {
          r += append3bytes(data.charCodeAt(i), data.charCodeAt(i + 1), 0)
        } else if (i + 1 === data.length) {
          r += append3bytes(data.charCodeAt(i), 0, 0)
        } else {
          r += append3bytes(data.charCodeAt(i),
            data.charCodeAt(i + 1),
            data.charCodeAt(i + 2))
        }
      }
      return r
    }

    return encode(text)
  }
</script>
{{ nodes.first }}
{%- for node in nodes offset:1 -%}
  {% assign tag = node | split: '">' | first %}
  {%- if types contains tag -%}
    {% assign contents = node
      | replace_first: tag, ''
      | replace_first: '">', ''
      | strip
      | split: '</code></pre>'
    %}
    {% capture text %}{% include capturehtml.liquid text=contents.first %}{% endcapture %}
    <img src="PUML-PLACEHOLDER-{{ forloop.index }}">
    <script>
      document.querySelector("img[src='PUML-PLACEHOLDER-1']").src = `https://www.plantuml.com/plantuml/png/${encodeToPlantumlEncoded(pako.deflateRaw(`{{ text }}`.trim(), { level: 9, to: 'string' }))}`
    </script>
    {%- for tail in contents offset:1 -%}
      {{ tail }}</code></pre>
    {%- endfor -%}
  {%-else -%}
    <pre><code class="language-{{ node }}
  {%- endif -%}
{%- endfor -%}
